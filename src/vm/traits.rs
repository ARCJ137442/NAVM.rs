//! å¼•å…¥ã€Œéå…¬ç†è™šæ‹Ÿæœºã€çš„ç‰¹å¾

use crate::{cmd::Cmd, output::Output};
use anyhow::Result;

/// è™šæ‹Ÿæœºè¿è¡Œæ—¶
/// * ğŸ¯æ‰€æœ‰**å·²å¯åŠ¨**çš„ã€Œéå…¬ç†è™šæ‹Ÿæœºã€éµå¾ªçš„ç‰¹å¾
/// * ğŸš©ã€2024-03-21 21:48:22ã€‘ç›®å‰æ–¹æ¡ˆï¼šé€šè¿‡ä¸€ä¸ªå¯åŠ¨å™¨è¿›è¡Œå¯åŠ¨
///
/// ## åŸºæœ¬ç†è®ºæ¨¡å‹
///
/// ã€Œéå…¬ç†è™šæ‹Ÿæœºã€çš„è¿è¡Œæ—¶ï¼Œç®€å•è€Œè¨€åªåšä¸¤ä»¶äº‹ï¼š
/// * è¾“å…¥ï¼šä»æŸå¤„æ¥æ”¶ã€ŒæŒ‡ä»¤ã€[`crate::cmd::Cmd`]
/// * è¾“å‡ºï¼šäº§ç”Ÿä¸€ç³»åˆ—ã€Œè¾“å‡ºã€[`crate::output::Output`]
///
/// åœ¨è¿™ä¸¤ä»¶äº‹ä¹‹é—´ï¼Œè™šæ‹Ÿæœºå’Œå¤–ç•Œæ˜¯**å¹¶è¡Œ**è¿ä½œçš„
/// * ğŸ“Œè¾“å…¥ã€è¾“å‡ºéƒ½æ˜¯**å¼‚æ­¥**çš„
///   * è¾“å…¥è™šæ‹Ÿæœºçš„æŒ‡ä»¤ï¼Œä¸ä¼šåœ¨å‡½æ•°å±‚é¢æœ‰ä»»ä½•è¿”å›å€¼
///   * ä»è™šæ‹Ÿæœºå‘å‡ºçš„è¾“å‡ºï¼Œä¸ç›´æ¥ä¸ã€Œè¾“å…¥ã€ç›¸ç»‘å®š
pub trait VmRuntime {
    // è¾“å…¥ //

    /// ã€æŠ½è±¡ã€‘å‘è™šæ‹Ÿæœºè¾“å…¥NAVMæŒ‡ä»¤
    /// * ğŸ“Œå‡ ä¹æ˜¯ä¸€åˆ‡NAVMçš„æ ¸å¿ƒå‡½æ•°
    /// * ğŸ“Œæ˜¯ä¸€ä¸ª**å¼‚æ­¥**çš„æ–¹æ³•
    ///   * è¾“å…¥ä¹‹åä¸ä¼šæœ‰ã€Œå›ä¼ ã€ï¼ˆå³æ­¤å¤„è¿”å›å€¼ï¼‰
    ///   * å›ä¼ éœ€è¦åœ¨ã€Œè¾“å‡ºä¾¦å¬å™¨ã€è¿›è¡Œæ•è·
    /// * ğŸš©è¾“å…¥æ—¶æœ‰å¯èƒ½äº§ç”Ÿé”™è¯¯ï¼šæ­¤æ—¶è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯
    ///   * ğŸ“„æŒ‡ä»¤è½¬è¯‘é”™è¯¯
    fn input_cmd(&mut self, cmd: Cmd) -> Result<()>;

    // è¾“å‡º //

    /// ã€æŠ½è±¡ã€‘ä»è™šæ‹Ÿæœºä¸­è·å–ä¸€ä¸ªè¾“å‡º
    /// * âš ï¸è‹¥æš‚æ—¶æ²¡è¾“å‡ºï¼Œåˆ™ä¼šé˜»å¡è°ƒç”¨è€…
    /// * ğŸ“Œè¾“å‡ºé¡ºåº**ä»æ—§åˆ°æ–°**ï¼šå…ˆäº§ç”Ÿçš„è¾“å‡ºå…ˆè¢«æ‹‰å–å‡ºæ¥
    fn fetch_output(&mut self) -> Result<Output>;

    /// ã€æŠ½è±¡ã€‘å°è¯•ä»è™šæ‹Ÿæœºä¸­è·å–ä¸€ä¸ªè¾“å‡º
    /// * ğŸš©é€»è¾‘ç±»ä¼¼[`VmRuntime::fetch_output`]ï¼Œä½†æ˜¯éé˜»å¡ç‰ˆæœ¬
    /// * ğŸš©å¯èƒ½æ²¡æœ‰ï¼šæ­¤æ—¶è¯´æ˜è™šæ‹Ÿæœºæ²¡æœ‰è¾“å‡º
    /// * âŒã€2024-03-24 23:29:16ã€‘å¯èƒ½æ— æ³•å¯¹ä¸€äº›ç±»å‹å®ç°`has_output`ï¼Œæ•…ä¸æä¾›é»˜è®¤å®ç°
    fn try_fetch_output(&mut self) -> Result<Option<Output>>;

    // ç”Ÿå‘½å‘¨æœŸ //

    /// ã€æŠ½è±¡ã€‘ç»ˆæ­¢è™šæ‹Ÿæœº
    /// * âš ï¸å¯èƒ½ä¼šé˜»å¡è°ƒç”¨è€…
    fn terminate(self) -> Result<()>;
}

// ! âŒã€2024-03-24 23:28:30ã€‘æ— æ³•è‡ªåŠ¨å®ç°`Drop`ç‰¹å¾ï¼šå­¤å„¿è§„åˆ™ã€Œä¸è¯¥è§¦åŠå…¶å®ƒåœ°æ–¹å®ç°çš„ç±»å‹ã€
// impl<T: VmRuntime> Drop for T {
//     fn drop(&mut self) {
//         self.terminate()
//             .unwrap_or_else(|e| println!("è¿è¡Œæ—¶è‡ªåŠ¨å…³é—­å‡ºç°é”™è¯¯ï¼{e:?}"));
//     }
// }

/// è™šæ‹Ÿæœºå¯åŠ¨å™¨
/// * ğŸ“Œä½¿ç”¨Rustçš„ã€ŒBuilderæ¨¡å¼ã€
///   * ğŸš©æ•´ä½“ä½¿ç”¨æµç¨‹ï¼šæ„é€ ã€é“¾å¼è°ƒç”¨åŠ é…ç½®ã€æœ€åè½¬æ¢æˆè¿è¡Œæ—¶
/// * ğŸ¯ç”¨äºã€Œæ–°å»ºé…ç½®ã€æ„å»ºå‚æ•°ã€å¯åŠ¨ã€çš„åˆå§‹åŒ–æµç¨‹
///   * ğŸ“„å¦‚ï¼š`VmCommand::new()`
///
/// ! ğŸ“ä¸èƒ½åœ¨å¸¦æœ‰`self`çš„æ–¹æ³•ä¸­ä½¿ç”¨é»˜è®¤å®ç°ï¼š`Self`å†…å­˜å¤§å°æœªçŸ¥
/// @template `Runtime` è¦æ„å»ºåˆ°çš„è¿è¡Œæ—¶
pub trait VmLauncher<Runtime: VmRuntime> {
    /// ä»builderæ„å»ºå¹¶å¯åŠ¨è¿è¡Œæ—¶
    /// * âš ï¸æ¶ˆè€—è‡ªèº«
    /// * ğŸ“Œç±»å‹æŒ‡å®šä¸ºç‰¹å®šçš„è¿è¡Œæ—¶
    /// * ğŸ“Œå…¼ã€Œæ„å»ºã€å’Œã€Œå¯åŠ¨ã€ï¼šæ­¤æ—¶çš„è¿è¡Œæ—¶åº”è¯¥**å³åˆ»å¯åŠ¨**/å¤±è´¥
    /// * ğŸ“Œç†å¿µï¼šæ„å»ºå¥½åçš„è¿è¡Œæ—¶ï¼Œè¦ä¹ˆæ˜¯ã€Œå¾…å¯åŠ¨çš„é…ç½®çŠ¶æ€ã€ï¼Œè¦ä¹ˆæ˜¯ã€Œåœ¨è¿è¡Œçš„ã€è¿è¡Œæ—¶çŠ¶æ€ã€ã€
    ///   * ğŸ“„å¦‚ã€Œå‘½ä»¤è¡Œè¿è¡Œæ—¶ã€ä¼šç«‹å³å¯åŠ¨å­è¿›ç¨‹ï¼ˆåŠå…¶è¾…åŠ©çº¿ç¨‹ï¼‰
    /// * ğŸš©ã€2024-04-02 04:13:25ã€‘å› ã€Œåé¦ˆå¹¶å¤„ç†é”™è¯¯ã€çš„éœ€è¦ï¼Œç°åœ¨éœ€è¦[`Result`]
    fn launch(self) -> Result<Runtime>;
}
